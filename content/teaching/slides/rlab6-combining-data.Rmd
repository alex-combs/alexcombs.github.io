---
title: "PADP 7120 Data Applications in PA"
subtitle: "RLab 6: Combining Data"
author: "Alex Combs"
institute: "UGA | SPIA | PADP"
date: "September 23, 2020"
output:
  xaringan::moon_reader:
    css: 'mypres.css'
    nature:
      beforeInit: "macros.js"
      highlightStyle: github
      countIncrementalSlides: false
      highlightlines: true
---
# Objectives

By the end of this lab, you will have learned how to...

- Handle the most common scenarios involving the combination of multiple datasets
  - Append
  - Right/left join

---
# Start a new project
- Using the file directory on your computer
  - Go to the parent folder that contains your RLabs folders
  - Create a new folder named RLab5

- In RStudio
  - Create new project
  - Select Existing Directory
  - Click Browse and select the RLab5 folder you just created
  - Click Create Project
  
---
# Start a R notebook

- Use the dropdown menu in the upper-left of RStudio to start a notebook

- Change YAML

```{r, eval=FALSE}
---
title: "RLab 5: Visualizations"
author: "Your Name"
output: 
  html_document:
    theme: spacelab
    df_print: paged
---
```

- Delete all of the content included in the template

---
# Packages

- Load the following packages, suppressing the code and output.

--

```{r, message=FALSE}
library(data.table)
library(tidyverse)
library(lubridate)
```

---
# County COVID Data

- Open your RLab5 notebook
- Copy and paste the code needed to recreate the Georgia COVID data used for RLab5

```{r}
covid <- fread('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv')

covid_ga <- covid %>% 
  filter(state == 'Georgia')

covid_ga$date <- ymd(covid_ga$date)
today <- '2020-08-16'

covid_ga$county <- as.factor(covid_ga$county)
```

- We will create the five counties dataset once we have added data to this dataset

---
# County Covid Data

- Recreate daily counts

```{r}
covid_ga <- covid_ga %>% 
  group_by(county) %>% 
  arrange(date) %>% 
  mutate(day_cases = cases - lag(cases),
         day_deaths = deaths - lag(deaths)) %>% 
  ungroup()
```

- We are now have the data we ended last lab with, updated with the most recent data

---
# Download & Import Data

- Download the `st_fin_2014.csv`, `st_fin_2015.csv`, and `st_fin_2016.csv` files from eLC and add them to your project folder.
- Import them into R.

```{r, eval=FALSE}
st_fin_14 <- 
st_fin_15 <- 
st_fin_16 <- 
```

--

```{r, eval=FALSE}
st_fin_14 <- read_csv("st_fin_2014.csv")
st_fin_15 <- read_csv("st_fin_2015.csv")
st_fin_16 <- read_csv("st_fin_2016.csv")
```

```{r, include=FALSE}
st_fin_14 <- read_csv("labs_files/st_fin_2014.csv")
st_fin_15 <- read_csv("labs_files/st_fin_2015.csv")
st_fin_16 <- read_csv("labs_files/st_fin_2016.csv")
```

---
# Append

- Combining observations among two or more datasets with **identical** layout. 

- Example: Adding multiple time periods together of the same data that is released annually.

![:scale 50%](labs_files/append.png)

---
# Append

- Appending is pretty easy to do in something like Excel, but it can become very tedious if you need to append many datasets

- And like always, Excel doesn't allow the process to be easily replicated for later use

- R can append datasets with much less work involved

---
# Append Example

```{r, include=FALSE}
library(gapminder)

gapminder07 <- gapminder %>% 
  filter(year == 2007) %>% 
  select(country, year, gdpPercap)

gapminder02 <- gapminder %>% 
  filter(year == 2002) %>% 
  select(country, year, gdpPercap)

gapminder97 <- gapminder %>% 
  filter(year == 1997) %>% 
  select(country, year, gdpPercap)
```

- Suppose I need to append three datasets with same layout but different years

```{r}
glimpse(gapminder07)
glimpse(gapminder02)
```

---
# Append Example

```{r}
glimpse(gapminder97)
```

- To append, all we need to do is `bind` the `rows` of each dataset using the `bind_rows` function

- General logic

```{r, eval=FALSE}
new_dataset <- bind_rows(dataset1, dataset2, ...)
```

---
# Append Example

```{r}
gapminder97_07 <- bind_rows(gapminder97, gapminder02, gapminder07)

glimpse(gapminder97_07)
```

- Note that there are now 426 rows in the new dataset (3 x 142)

---
# Append Practice

- You have three datasets with the same layout

```{r}
glimpse(st_fin_16)
```

- Append them to create a new dataset `st_fin_14_16`

--

```{r}
st_fin_14_16 <- bind_rows(st_fin_16, st_fin_15, st_fin_14)
```

---
# Append Practice

- Take a `glimpse` of your new dataset to confirm it worked

```{r, eval=FALSE}
glimpse(st_fin_14_16)
```

- You should have 150 observations (3 years X 50 states)

- Now we can explore things like changes in state finances over time if we wanted to

---
# Left (and Right) Joins

- A left join (aka merge) is used when we want to add variables from a new dataset (y) to our main dataset (x), matching across common units of analysis (key)
- Keeps ALL of the observations in our main dataset
- Observations in our new dataset that don't match with the main dataset aren't added

![:scale 75%](labs_files/left_join.png)

---
# Key is Key to Joins/Merges

- The `key` is the variable or set of variables that uniquely identify each observation/row that is shared across the datasets you want to join.

- If you can identify the unit of analysis in both datasets, you have identified the key to use for joins

- Datasets must have the same key in order to join them; they do not need to be named the same across datasets

---
# General Logic of Left Joins

- If a single variable is the key and named the same across datasets

```{r, eval=FALSE}
new_dataset <- name_of_x_dataset %>% 
  left_join(name_of_y_dataset, 
            by = "name_of_key")
```

--

-  If multiple variables of the same name are the key

```{r, eval=FALSE}
new_dataset <- name_of_x_dataset %>% 
  left_join(name_of_y_dataset, 
            by = c("name_of_key1", "name_of_key2", ...))
```

---
# General Logic of Left Joins

- If one variable is the key and named differently across datasets

```{r, eval=FALSE}
new_dataset <- name_of_x_dataset %>% 
  left_join(name_of_y_dataset, 
            by = c("key_in_x_data" = "key_in_y_data"))
```

--

- If multiple variables are the key and at least one is named differently

```{r, eval=FALSE}
new_dataset <- name_of_x_dataset %>% 
  left_join(name_of_y_dataset, 
            by = c("key_in_x_data" = "key_in_y_data",
                   "common_key", ...))
```

---
# Left Join Example

- Suppose I want to add population to the `gapminder97_07` that I appended earlier

```{r}
glimpse(gapminder97_07)
```

---
# Left Join Example

- Suppose I could find population data for only the U.S.

```{r, include=FALSE}
gap_pop_US <- gapminder %>% 
  select(country, year, pop) %>% 
  filter(country == "United States")
```

```{r}
glimpse(gap_pop_US)
```

- Note that there are only 12 observations, not 426 as in `gapminder97_07`

---
# Left Join Example

- What is the key for `gapminder97_07` and `gap_pop_US`?

--

- `country` AND `year`

--

```{r}
gap_pop_97_07 <- gapminder97_07 %>% 
  left_join(gap_pop_US, 
            by = c('country', 'year'))
```

---
# Left Join Example

```{r, include=FALSE}
library(arsenal)
sum.gap_pop_97_07 <- tableby(~ gdpPercap + pop, 
                   data = gap_pop_97_07, digits = 0)
```

```{r, results='asis'}
summary(sum.gap_pop_97_07)
```

- Why are we missing 423 values for population?

---
# Left Join Practice

- Download `ga_county_pop.csv`, add it to your project folder, and import into R

--

```{r, eval=FALSE}
ga_county_pop <- read_csv('ga_county_pop.csv')
```

```{r, include=FALSE}
ga_county_pop <- read_csv('labs_files/ga_county_pop.csv')
```

---
# County Pop Data

- These data include total county population for 2019 from the Census

```{r}
glimpse(ga_county_pop)
```

- What is the key between `covid_ga` and `ga_county_pop`?

--

- `county` (not ideal to match using names but it's what we got)

---
# Variable Type Mismatch

- Before using a key to join data, make sure they are stored as the same type in both datasets

- `county` is stored as a factor in `covid_ga` and character in `ga_county_pop`

- Convert `county` to factor in `ga_county_pop`

--

```{r}
ga_county_pop$county <- as.factor(ga_county_pop$county)
```

- Now we are ready to join `ga_county_pop` to `covid_ga`. Give it a shot. Overwrite `covid_ga` instead of creating a new dataset.

---
# Left Join Practice

```{r}
covid_ga <- covid_ga %>% 
  left_join(ga_county_pop, by = 'county')
```

- Take a `glimpse` of our dataset

```{r}
glimpse(covid_ga)
```

---
# Recap

- In one chunk of code, we had R merge each county's population to all of the rows for that county in our COVID data

- We are now ready to compute rates and visualize fair comparisons

- We will pick that up next week

- Upload your notebook to eLC

---
# Several other types of joins

- Inner joins are sometimes useful

![:scale 75%](labs_files/inner_join.png)

- Just replace `left_join` with `inner_join` in the code we wrote