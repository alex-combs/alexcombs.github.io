---
title: "PADP 7120 Data Applications in PA"
subtitle: "RLab 4: Tidying Data"
author: "Alex Combs"
institute: "UGA | SPIA | PADP"
date: "Last updated: `r format(Sys.time(), '%B %d, %Y')`"
output:
  xaringan::moon_reader:
    css: 'mypres.css'
    nature:
      beforeInit: "macros.js"
      highlightStyle: github
      countIncrementalSlides: false
      highlightlines: true
---
# Objectives

- Pivot a wide dataset to long
- Pivot a long dataset to wide
- Separate a variable into multiple variables

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
library(gapminder)
```

---
# Set-up

.pull-left[

> **If using RStudio Cloud, do not create a new project space. Instead, use the project that has all packages installed. Installed packages do not carry over to other project spaces.**

]

.pull-right[

> **Otherwise, create a new project named "rlab4". I recommend locating it in the same parent file as your other RLab folders.**

]

---
# Setup
  
> **Start a new R Markdown document and click "OK"**

> **Keep setup code chunk at the top. Change code to `echo=FALSE`**

> **Change YAML:**

```{r, eval=FALSE}
---
title: "RLab4: Tidying Data"
author: "Your Name"
output:
  html_document:
    df_print: paged
---
```

> **Delete rest of the template.**

---
# Setup: Packages

> **In the setup code chunk, load the following packages:**

```{r, eval=FALSE}
library(tidyverse)
```

---
# Setup: Data

> **Download the "state_finance_2016_wrangled.csv" and "ky_private_school_enrollment.csv" files from eLC and add to your project folder**

- The "state_finance_2016_wrangled.csv" should be identical to the one you exported during the wrangle practice. You could copy that file over to this folder but is offered on eLC in case you don't trust your version.  

> **In the setup code chunk, import "state_finance_2016_wrangled.csv" and "ky_private_school_enrollment.csv". You do not need to use any import options. Name the saved datasets in your environment the same as the file names.**

```{r, include=FALSE}
state_finance_2016_wrangled <- read_csv("labs_files/state_finance_2016_wrangled.csv")

ky_private_school_enrollment <- read_csv("labs_files/ky_private_school_enrollment.csv")
```

---
# Tidy data

Tidy data satisfy three rules:

- Each variable has its own column
- Each observation (unit of analysis) has its own row
- Each value (datum) has its own cell

![](labs_files/tidy.png)

---
# Tidy data

> **Insert a heading "Untidy State Finance Data"**

--

- Let's show readers a preview of the data

> **In a new code chunk, provide the first 4 rows of `state_finance_2016_wrangled`.**

```{r, echo=FALSE}
state_finance_2016_wrangled %>% 
  slice_head(n = 4) %>% 
  kable()
```

--

- Are these data tidy? Why or why not?

---
# Untidy Data

```{r, echo=FALSE}
state_finance_2016_wrangled %>% 
  slice_head(n=4) %>% 
  kable()
```

- What is the unit of analysis?

--

- There are two rows per observation (unit of analysis)

--

- Why?

--

- Because `finance_source` should be two variables, not one

---
# Long vs. Wide Data

- Most tidying issues involve whether a dataset should be long or wide

--

- Is `state_finance_2016_wrangled` in long or wide format?

```{r, echo=FALSE}
state_finance_2016_wrangled %>% 
  slice_head(n=4) %>% 
  kable()
```

---
# Long vs. Wide Data

- Here is a different example that is very common.

```{r, echo=FALSE}
uspop <- gapminder %>% 
  filter(country == 'United States' & year >= 1997) %>% 
  select(country, year, pop) %>% 
  pivot_wider(names_from = year, names_prefix = 'pop', values_from = pop) 

 
kable(uspop, format = 'html')
```

- Are these data in long or wide format?

--

- Are these data tidy? Why or why not?

---
# Tidy State Finance Data

- Our goal is to tidy `state_finance_2016_wrangled`

- It is long when it should be wide

--

- To achieve this, we can use the `pivot_wider` function

- General syntax:

```{r, eval=FALSE}
new_data <- current_data %>% 
  pivot_wider(names_from = column-with-variable-names,
              values_from = column-with-values)
```

---
# Tidy State Finance Data

```{r, echo=FALSE}
state_finance_2016_wrangled %>% 
  slice_head(n=2) %>% 
  kable()
```

> **Insert a heading "Tidy State Finance Data"**

> **Start a code chunk. Save a new dataset `state_finance_2016_tidy` that is a copy of `state_finance_2016_wrangled`**

```{r, eval=FALSE}
state_finance_2016_tidy <- state_finance_2016_wrangled %>% 
```

---
# Tidy State Finance Data

```{r, echo=FALSE}
state_finance_2016_wrangled %>% 
  slice_head(n=2) %>% 
  kable()
```

```{r, eval=FALSE}
new_data <- current_data %>% 
  pivot_wider(names_from = column-with-variable-names,
              values_from = column-with-values)
```

- Which column contains the names of the new variables we want?
- Which column contains the values for the new variables?
> **Add `pivot_wider` to your code chunk according to answers.**

---
# Tidy State Finance Data

```{r}
state_finance_2016_tidy <- state_finance_2016_wrangled %>% 
  pivot_wider(names_from = finance_source,
              values_from = amount_1000)
```

> **Run your code and examine the new dataset to see if/how it worked.**

---
# Tidy State Finance Data

> **Provide the reader with top 4 rows of the new dataset.**

```{r, echo=FALSE}
state_finance_2016_tidy %>% 
  slice_head(n=4) %>% 
  kable()
```

---
# Changing variable names

- The variable names in our `state_finance_2016_tidy` are not ideal.

> **Change "Total Revenue" to `revenue` and "Total Expenditure" to `expenditure`.**

```{r, echo=FALSE}
state_finance_2016_tidy <- state_finance_2016_tidy %>% 
  rename('revenue' = 'Total Revenue', 
         'expenditure' = 'Total Expenditure')
```

---
# Summarize by Group

- Recall in the wrangle practice you computed the average `amount_1000` but realized it was meaningless because it combined revenues and expenditures.

> **Now create a new variable that computes the surplus (revenue - expenditure) for each state. Provide a table that lists surplus in descending order for three states with highest surplus.**

```{r, echo=FALSE}
state_finance_2016_tidy %>% 
  mutate(surplus = revenue - expenditure) %>% 
  select(state, surplus) %>% 
  arrange(desc(surplus)) %>% 
  slice_head(n=3) %>% 
  kable()
```

---
# Wide to Long

```{r, echo=FALSE}
kable(uspop, format = 'html')
```

- To tidy wide data to long format, we can use `pivot_longer`

```{r}
uspop_tidy <- uspop %>% 
  pivot_longer(cols = pop1997:pop2007,
               names_to = 'year',
               names_prefix = 'pop',
               values_to = 'population')
```

```{r, echo=FALSE}
kable(uspop_tidy)
```

---
# Untidy Enrollment Data

> **Provide the reader the first 3 rows of the `ky_private_school_enrollment`**

```{r, echo=FALSE}
slice_head(ky_private_school_enrollment, n=3) %>% 
  kable()
```

---
# Untidy Enrollment Data

- We need to take the `enrollyear` columns and name them to a new variable `year` and send the values to a variable we will name `enrollment`

- Recall how this was done for the `uspop` data

```{r, eval=FALSE}
uspop_tidy <- uspop %>% 
  pivot_longer(cols = pop1997:pop2007,
               names_to = 'year',
               names_prefix = 'pop',
               values_to = 'population')
```

> **Create a new dataset called `ky_private_enroll_long` that pivots `ky_private_school_enrollment` to long format**

```{r, include=FALSE}
ky_private_enroll_long <- ky_private_school_enrollment %>% 
  pivot_longer(cols = enroll2000:enroll2010,
               names_to = 'year',
               names_prefix = 'enroll',
               values_to = 'enrollment')
```

---
# Enrollment Data

```{r, echo=FALSE}
ky_private_enroll_long %>%
  slice_head(n=3) %>% 
  kable()
```

- Are these data tidy? Why or why not?

---
# Separating variables

![](labs_files/separate.png)

---
# Tidy Enrollment Data

- We should `separate` city_county into city and county

> **Create a new dataset `ky_priv_enroll_tidy` that separates `city_county` in `ky_private_enroll_long.`**

--

```{r, warning=FALSE}
ky_priv_enroll_tidy <- ky_private_enroll_long %>% 
  separate(city_county, c('city', 'county'))
```

--

> **Finally, provide the reader the first 6 rows of these tidy data**

> **Knit to HTML and check that the output looks correct**

---
# Upload Lab

- Upload your .Rmd file to eLC