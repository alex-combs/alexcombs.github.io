---
title: "PADP 7120 Data Applications in PA"
subtitle: "Regression with Nonlinear Variables"
author: "Alex Combs"
institute: "UGA | SPIA | PADP"
date: "Last updated: `r format(Sys.time(), '%B %d, %Y')`"
output:
  xaringan::moon_reader:
    css: 'mypres.css'
    nature:
      beforeInit: "macros.js"
      highlightStyle: github
      countIncrementalSlides: false
      highlightLines: true
---
# Outline

```{r, include=FALSE}
library(tidyverse)
library(moderndive)
library(knitr)
library(gapminder)
load('lectures_files/wages.RData')
options(scipen = 999)
```

- Why use nonlinear variables

- How to interpret coefficients for nonlinear variables

- Assess goodness of fit

---
# Why use nonlinear variables

- The relationship between $x$ and $y$ may not follow a straight line

```{r, echo=FALSE, message=FALSE, fig.align='center', fig.height=6}
gapminder %>% 
  filter(year == 2007) %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp)) +
  geom_point(alpha = 0.5, color = 'steelblue', size = 2) +
  geom_smooth(method = 'lm', se = FALSE, color = 'blue') +
  geom_smooth(span = 1, se = FALSE, color = 'red') + #<<
  labs(y = 'Life Expectancy', x = 'GDP per Capita') +
  theme_minimal()
```

---
# Common nonlinear variables

- Quadratic model

- Logarithmic model
  - Log-log
  - Log-level
  - Level-log

---
# Quadratic model

$$y=\beta_0+\beta_1x_1+\beta_2x_1^2+\beta_3x_2+...+\beta_kx_{k-1}+\epsilon$$

```{r, echo=FALSE, fig.align='center'}
include_graphics('lectures_files/quadratic.png', dpi = 125)
```

.pull-left[
$b_1$ will be negative and $b_2$ will be positive
]

.pull-right[
$b_1$ will be positive and $b_2$ will be negative
]

---
# Quadratic directions

$$y= 100 + 10 \times x - 1 \times x^2$$

```{r, include=FALSE}
quad.dir <- tibble(
  'x' = c(0,2,4,6,8,10,12,14),
  'b1' = c(10,10,10,10,10,10,10,10),
  'x*b1' = c(0,20,40,60,80,100,120,140),
  'x^2' = c(0,4,16,36,64,100,144,196),
  'b2' = c(-1,-1,-1,-1,-1,-1,-1,-1),
  'x^2*b2' = c(0,-4,-16,-36,-64,-100,-144,-196),
  'y' = c(100,116,124,124,116,100,76,44)
)
```

.pull-left[
```{r, echo=FALSE}
kable(quad.dir)
```
]

.pull-right[
```{r, echo=FALSE, message=FALSE}
ggplot(quad.dir, aes(x, y)) +
  geom_point()+
  geom_path()+
  scale_x_continuous(breaks = c(0,2,4,6,8,10,12,14)) +
  theme_minimal() +
  theme(axis.text = element_text(size=14))
```
]
---
# Quadratic regression

$$y=\beta_0+\beta_1x_1+\beta_2x_1^2+\epsilon$$

--

- What is the change in $y$ from a unit-change in $x$?

$$b_1+2b_2x_1$$

- Depends on the value of $x$

--

- At what value of $x$ is $y$ at its maximum or minimum?

$$x = \frac{-b_1}{2b_2}$$

---
# Marginal and optimal

$$y= 100 + 10 \times x - 1 \times x^2$$

- What is the marginal effect of $x$ at $x=2$?

--

- At what value of $x$ is $y$ at its maximum?

---
class: inverse, center, middle

# Quadratic regression example using R

---
# Data

```{r, echo=FALSE}
summary(wages)
```

- Note average age is about 49

---
# Viz

```{r, echo=FALSE, message=FALSE, fig.align='center', fig.height=6}
ggplot(wages, aes(x = Age, y = Wage)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = 'blue') +
  geom_smooth(se = FALSE, span = 1, color = 'red') +
  theme_minimal()
```

---
# Quadratic regression

$$Wage=\beta_0+\beta_1Educ+\beta_2Age+\beta_3Age^2+\epsilon$$

```{r}
quad <- lm(Wage ~ Educ + Age + I(Age^2), data = wages)
```

```{r, eval=FALSE}
get_regression_table(quad)
```

```{r, echo=FALSE}
get_regression_table(quad) %>% 
  kable()
```

$$\hat{Wage}=-22.7+1.25*Educ+1.35*Age-0.013*Age^2$$

---
# Interpretation

$$\hat{Wage}=-22.7+1.25*Educ+1.35*Age-0.013*Age^2$$

- What is the marginal effect of age on wage at 49 years old?

- At what age are wages at their maximum?

- What is the predicted wage for a 26-year old with 16 years of education?

---
class: inverse, center, middle

# Let's practice using another example involving a quadratic variable

---
class: inverse, center, middle

# Log Transformations

---
# Why use log transformation

- Transform skewed data to be more normal

- Express change in percentages instead of units

--

- Reflect our theoretical claim for the relationship between two variables
  - Based on scatterplot, or
  - We believe the effect of a change in X on Y depends on the starting value of X, but the effect never switches sign

---
# Transform skewed data

```{r, fig.align='center', fig.height=6}
ggplot(gapminder, aes(x = gdpPercap)) + #<<
  geom_histogram(bins = 50, fill = 'steelblue', color = 'white') +
  theme_minimal()
```

---
# Transform skewed data

```{r, fig.align='center', fig.height=6}
ggplot(gapminder, aes(x = log10(gdpPercap))) + #<<
  geom_histogram(bins = 50, fill = 'steelblue', color = 'white') +
  theme_minimal()
```

---
# Transform skewed data

```{r, fig.align='center', fig.height=5.5}
ggplot(gapminder, aes(x = gdpPercap)) +
  geom_histogram(bins = 50, fill = 'steelblue', color = 'white') +
  scale_x_log10(labels = scales::dollar) + #<<
  theme_minimal()
```

---
# Transform skewed data

```{r, message=FALSE, fig.align='center', fig.height=5}
gapminder %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp)) +
  geom_point(color = 'steelblue', alpha = 0.4) +
  labs(x = 'GDP per capita', y = 'Life expectancy') +
  theme_minimal()
```

---
# Transform skewed data

```{r, message=FALSE, fig.align='center', fig.height=4.5}
gapminder %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp)) +
  geom_point(color = 'steelblue', alpha = 0.4) +
  scale_x_log10(labels = scales::dollar) + #<<
  labs(x = 'Log GDP per capita', y = 'Life expectancy') +
  theme_minimal()
```

---
class: inverse, center, middle

# Log models, interpretation, and using them in R

---
# Log-log Model

$$ln(y)=\beta_0+\beta_1ln(x_1)+...+\beta_kx_k+\epsilon$$
$$ln(\hat{y})=b_0+b_1ln(x_1)+...+b_kx_k$$

```{r, echo=FALSE, fig.align='center'}
include_graphics('lectures_files/log-log.png', dpi = 150)
```

---
# Interpreting Log-log Model

$$ln(\hat{y})=b_0+b_1ln(x_1)+...+b_kx_k$$

- As $x_1$ increases 1%, y changes $b_1$%

- This is how **elasticities** are estimated

---
# Log-log model in R

$$ln(LifeExp)=\beta_0+\beta_1ln(GDPperCap)+\beta_2Continent+\epsilon$$

```{r}
log_log <- lm(log(lifeExp) ~ log(gdpPercap) + continent, 
               data = gapminder)
```

---
# Log-log model in R

```{r, eval=FALSE}
get_regression_table(log_log) %>% 
  select(term, estimate)
```

.pull-left[
```{r, echo=FALSE}
get_regression_table(log_log) %>% 
  select(term, estimate) %>% 
  kable(digits = 3)
```
]

.pull-right[

- How do we interpret `log(gdpPercap)` coefficient?

]

---
# Level-log Model

$$y=\beta_0+\beta_1ln(x_1)+...+\beta_kx_k+\epsilon$$
$$\hat{y}=b_0+b_1ln(x_1)+...+b_kx_k$$

```{r, echo=FALSE, fig.align='center'}
include_graphics('lectures_files/level-log.png', dpi = 150)
```

---
# Interpreting Level-log Model

$$\hat{y}=b_0+b_1ln(x_1)+...+b_kx_k$$

- As $x_1$ increases 1%, y changes $\frac{b_1}{100}$ units

- Remember, any variable that is log-transformed will be expressed in percent change. $y$ has not been transformed so it is expressed in unit change.

---
# Level-log Model in R

$$LifeExp=\beta_0+\beta_1ln(GDPperCap)+\beta_2Continent+\epsilon$$

```{r}
lev_log <- lm(lifeExp ~ log(gdpPercap) + continent, 
               data = gapminder)
```

---
# Level-log Model in R

```{r, eval=FALSE}
get_regression_table(lev_log) %>% 
  select(term, estimate)
```

.pull-left[
```{r, echo=FALSE}
get_regression_table(lev_log) %>% 
  select(term, estimate) %>% 
  kable(digits = 3)
```
]

.pull-right[

- How do we interpret `log(gdpPercap)` coefficient?

]

---
# Log-level Model (Exponential Model)

$$ln(y)=\beta_0+\beta_1x_1+...+\beta_kx_k+\epsilon$$
$$ln(\hat{y})=b_0+b_1x_1+...+b_kx_k$$

```{r, echo=FALSE, fig.align='center'}
include_graphics('lectures_files/log-level.png', dpi=150)
```

---
# Interpreting Log-level Model

$$ln(\hat{y})=b_0+b_1x_1+...+b_kx_k$$

- As $x_1$ increases 1 unit, y changes $b_1 \times 100$ percent

---
# Log-level Model in R

$$ln(LifeExp)=\beta_0+\beta_1GDPperCap+\beta_2Continent+\epsilon$$

```{r}
log_lev <- lm(log(lifeExp) ~ gdpPercap + continent, 
               data = gapminder)
```

---
# Log-level Model in R

```{r, eval=FALSE}
get_regression_table(log_lev) %>% 
  select(term, estimate)
```

.pull-left[
```{r, echo=FALSE}
get_regression_table(log_lev) %>% 
  select(term, estimate) %>% 
  kable(digits = 7)
```
]

.pull-right[

- Rounded to 0. Suppose the estimate is 0.0004. How do we interpret `gdpPercap`?

]

---
class: inverse, center, middle

# What about those estimates for continent?

---
class: inverse, center, middle

# Time for more practice

---
# Predicting Value of Y

- Everything so far has focused on predicting *change* in $y$

- If you use $ln(y)$ in your regression, predicted *value* of $y$ will be in units of $ln(y)$

- How do we return natural log units to original units? Exponentiate.

$$e^{ln(y)}=y$$

--

```{r}
log(50)
```

```{r}
exp(3.912023)
```

---
# Predicting value of Y

$$ln(LifeExp)=\beta_0+\beta_1GDPperCap+\beta_2Continent+\epsilon$$
.pull-left[
```{r, echo=FALSE}
get_regression_table(log_lev) %>% 
  select(term, estimate) %>% 
  kable(digits = 3)
```
]

.pull-right[
- Suppose we want to know the predicted life expectancy of an American country with a GDP per capita of $30,000.
]

---
# Predicting value of Y

- **Step 1:** Usual calculation

- $3.856+30000*0.000007+0.25 = 4.316$

--

- **Step 2:** Add a correction term $\frac{SE^2}{2}$

```{r, echo=FALSE}
include_graphics('lectures_files/log-lev-rmse.png')
```

- $4.316 + \frac{0.158^2}{2} = 4.328$

--

- **Step 3:** Exponentiate

- $e^{4.328}=76$

---
# Predicting value of Y

```{r, message=FALSE, fig.height=5}
gapminder %>% 
  filter(continent == 'Americas') %>% 
  ggplot(aes(x = gdpPercap, y = lifeExp)) +
    geom_point() +
    geom_smooth() #<<
```


---
# Choosing the best model

- You can't compare models that use ln(y) to models that do not based on the default goodness of fit values.

- Converting goodness of fit models to be comparable is dense. Instead, use scatterplots and your best judgment to decide whether to log transform.